version: '3'

networks:
  lamassu-net:

volumes:
  consul_server_data:
  auth_pg_data:
  enroller_csr_store:
  enroller_pg_data:
  scep_pg_data:
  mosquitto_data:
  elastic_data:

services:
  consul-server:
    image: consul:latest
    volumes:
      - '${CONSUL_PATH}/config/consul:/consul/config'
      - 'consul_server_data:/consul/data'
      - '${CONSUL_PATH}/certs/consul/consul-server.crt:/consul/tls/tls.crt'
      - '${CONSUL_PATH}/certs/consul/consul-server.key:/consul/tls/tls.key'
    ports:
      - ${CONSUL_PORT}:${CONSUL_PORT}
      - ${CONSUL_HTTPS_PORT}:${CONSUL_HTTPS_PORT}
      - ${CONSUL_UDP_PORT}:${CONSUL_UDP_PORT}/udp
    command: consul agent -server -ui -client=0.0.0.0 -bootstrap-expect=1 -data-dir /consul/data -config-dir /consul/config
    networks:
      - lamassu-net
    depends_on:
      - fluentd
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'

  vault:
    image: vault:latest
    environment:
      VAULT_LOCAL_CONFIG: '${VAULT_LOCAL_CONFIG}'
      VAULT_API_ADDR: '${VAULT_API_ADDR}'
    volumes:
      - '${VAULT_PATH}/certs/vault:/vault/tls'
    ports:
      - ${VAULT_PORT}:${VAULT_PORT}
    command: vault server -config /vault/config
    cap_add:
      - IPC_LOCK
    depends_on: 
      - consul-server
      - fluentd
    networks:
      - lamassu-net
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'
  
  keycloak:
    image: 'jboss/keycloak:latest'
    environment:
      DB_VENDOR: '${KEYCLOAK_DB_VENDOR}'
      DB_ADDR: '${KEYCLOAK_DB_ADDR}'
      DB_DATABASE: '${KEYCLOAK_DB_DATABASE}'
      DB_USER: '${KEYCLOAK_DB_USER}'
      DB_PASSWORD: '${KEYCLOAK_DB_PASSWORD}'
      KEYCLOAK_USER: '${KEYCLOAK_USER}'
      KEYCLOAK_PASSWORD: '${KEYCLOAK_PASSWORD}'
    volumes:
      - '${KEYCLOAK_PATH}/certs:/etc/x509/https'
    ports:
      - ${KEYCLOAK_PORT}:${KEYCLOAK_PORT}
      - ${KEYCLOAK_HTTPS_PORT}:${KEYCLOAK_HTTPS_PORT}
    depends_on:
      - keycloakdb
      - fluentd
    networks:
      - lamassu-net
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'
  
  keycloakdb:
    image: 'postgres:latest'
    environment:
      POSTGRES_DB: '${KEYCLOAK_DB_DATABASE}'
      POSTGRES_USER: '${KEYCLOAK_DB_USER}'
      POSTGRES_PASSWORD: '${KEYCLOAK_DB_PASSWORD}'
    volumes:
      - 'auth_pg_data:/var/lib/postgresql/data'
    networks:
      - lamassu-net
    depends_on:
      - fluentd
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'

  scep:
    build: 
      context: https://github.com/lamassuiot/enroller.git#develop
      dockerfile: Dockerfile.scep
    environment:
      SCEP_PORT: '${ENROLLERSCEP_PORT}'
      SCEP_POSTGRESUSER: '${SCEP_POSTGRESUSER}'
      SCEP_POSTGRESDB: '${SCEP_POSTGRESDB}'
      SCEP_POSTGRESPASSWORD: '${SCEP_POSTGRESPASSWORD}'
      SCEP_POSTGRESHOSTNAME: '${SCEP_POSTGRESHOSTNAME}'
      SCEP_POSTGRESPORT: '${SCEP_POSTGRESPORT}'
      SCEP_ENROLLERUIHOST: '${ENROLLER_UIHOST}'
      SCEP_ENROLLERUIPORT: '${ENROLLER_UIPORT}'
      SCEP_ENROLLERUIPROTOCOL: '${ENROLLER_UIPROTOCOL}'
      SCEP_KEYCLOAKHOSTNAME: '${KEYCLOAKHOSTNAME}'
      SCEP_KEYCLOAKPORT: '${KEYCLOAKPORT}'
      SCEP_KEYCLOAKPROTOCOL: '${KEYCLOAKPROTOCOL}'
      SCEP_KEYCLOAKCA: '${ENROLLERSCEP_KEYCLOAKCA}'
      SCEP_KEYCLOAKREALM: '${KEYCLOAKREALM}'
      SCEP_CERTFILE: '${ENROLLERSCEP_CERTFILE}'
      SCEP_KEYFILE: '${ENROLLERSCEP_KEYFILE}'
      SCEP_CONSULPROTOCOL: '${CONSULPROTOCOL}'
      SCEP_CONSULHOST: '${CONSULHOST}'
      SCEP_CONSULPORT: '${CONSULPORT}'
      SCEP_CONSULCA: '${ENROLLERSCEP_CONSULCA}'
      JAEGER_SERVICE_NAME: '${ENROLLERSCEP_JAEGER_SERVICE_NAME}'
      JAEGER_AGENT_HOST: '${JAEGER_AGENT_HOST}'
      JAEGER_AGENT_PORT: '${JAEGER_AGENT_PORT}'
    volumes:
      - '${ENROLLER_PATH}/certs:${ENROLLERSCEP_CERTSPATH}'
    networks:
      - lamassu-net
    ports:
      - ${ENROLLERSCEP_PORT}:${ENROLLERSCEP_PORT}
    restart: on-failure
    depends_on:
      - scepdb
      - consul-server
      - vault
      - fluentd
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'
  
  enroller:
    build:
      context: https://github.com/lamassuiot/enroller.git#develop
      dockerfile: Dockerfile.enroller
    environment:
      ENROLLER_PORT: '${ENROLLER_PORT}'
      ENROLLER_HOMEPATH: '${ENROLLER_HOMEPATH}'
      ENROLLER_POSTGRESDB: '${ENROLLER_POSTGRESDB}'
      ENROLLER_POSTGRESUSER: '${ENROLLER_POSTGRESUSER}'
      ENROLLER_POSTGRESPASSWORD: '${ENROLLER_POSTGRESPASSWORD}'
      ENROLLER_POSTGRESHOSTNAME: '${ENROLLER_POSTGRESHOSTNAME}'
      ENROLLER_POSTGRESPORT: '${ENROLLER_POSTGRESPORT}'
      ENROLLER_KEYCLOAKHOSTNAME: '${KEYCLOAKHOSTNAME}'
      ENROLLER_KEYCLOAKPORT: '${KEYCLOAKPORT}'
      ENROLLER_KEYCLOAKREALM: '${KEYCLOAKREALM}'
      ENROLLER_KEYCLOAKPROTOCOL: '${KEYCLOAKPROTOCOL}'
      ENROLLER_KEYCLOAKCA: '${ENROLLER_KEYCLOAKCA}'
      ENROLLER_ENROLLERUIPROTOCOL: '${ENROLLER_UIPROTOCOL}'
      ENROLLER_ENROLLERUIHOST: '${ENROLLER_UIHOST}'
      ENROLLER_ENROLLERUIPORT: '${ENROLLER_UIPORT}'
      ENROLLER_CAPATH: '${ENROLLER_CAPATH}'
      ENROLLER_CACERTFILE: '${ENROLLER_CACERTFILE}'
      ENROLLER_CAKEYFILE: '${ENROLLER_CAKEYFILE}'
      ENROLLER_CERTFILE: '${ENROLLER_CERTFILE}'
      ENROLLER_KEYFILE: '${ENROLLER_KEYFILE}'
      ENROLLER_OCSPSERVER: '${ENROLLER_OCSPSERVER}'
      ENROLLER_CONSULPROTOCOL: '${CONSULPROTOCOL}'
      ENROLLER_CONSULHOST: '${CONSULHOST}'
      ENROLLER_CONSULPORT: '${CONSULPORT}'
      ENROLLER_CONSULCA: '${ENROLLER_CONSULCA}'
      JAEGER_SERVICE_NAME: '${ENROLLER_JAEGER_SERVICE_NAME}'
      JAEGER_AGENT_HOST: '${JAEGER_AGENT_HOST}'
      JAEGER_AGENT_PORT: '${JAEGER_AGENT_PORT}'
    volumes:
      - 'enroller_csr_store:${ENROLLER_HOMEPATH}'
      - '${ENROLLER_PATH}/ca:${ENROLLER_CAPATH}'
      - '${ENROLLER_PATH}/certs:${ENROLLER_CERTSPATH}'
    depends_on:
      - enrollerdb
      - consul-server
      - fluentd
    networks:
      - lamassu-net
    ports:
      - ${ENROLLER_PORT}:${ENROLLER_PORT}
    restart: on-failure
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'
  
  ca:
    build:
      context: https://github.com/lamassuiot/enroller.git#develop
      dockerfile: Dockerfile.ca
    environment:
      CA_PORT: '${CA_PORT}'
      CA_VAULTADDRESS: '${VAULT_API_ADDR}'
      CA_VAULTROLEID: '${CA_VAULTROLEID}'
      CA_VAULTSECRETID: '${CA_VAULTSECRETID}'
      CA_VAULTCA: '${CA_VAULTCA}'
      CA_CERTFILE: '${CA_CERTFILE}'
      CA_KEYFILE: '${CA_KEYFILE}'
      CA_KEYCLOAKHOSTNAME: '${KEYCLOAKHOSTNAME}'
      CA_KEYCLOAKPORT: '${KEYCLOAKPORT}'
      CA_KEYCLOAKREALM: '${KEYCLOAKREALM}'
      CA_KEYCLOAKCA: '${CA_KEYCLOAKCA}'
      CA_KEYCLOAKPROTOCOL: '${KEYCLOAKPROTOCOL}'
      CA_ENROLLERUIPROTOCOL: '${ENROLLER_UIPROTOCOL}'
      CA_ENROLLERUIHOST: '${ENROLLER_UIHOST}'
      CA_ENROLLERUIPORT: '${ENROLLER_UIPORT}'
      CA_CONSULPROTOCOL: '${CONSULPROTOCOL}'
      CA_CONSULHOST: '${CONSULHOST}'
      CA_CONSULPORT: '${CONSULPORT}'
      CA_CONSULCA: '${CA_CONSULCA}'
      JAEGER_SERVICE_NAME: '${CA_JAEGER_SERVICE_NAME}'
      JAEGER_AGENT_HOST: '${JAEGER_AGENT_HOST}'
      JAEGER_AGENT_PORT: '${JAEGER_AGENT_PORT}'
    volumes:
      - '${ENROLLER_PATH}/certs:${CA_CERTSPATH}'
    networks:
      - lamassu-net
    ports:
      - ${CA_PORT}:${CA_PORT}
    restart: on-failure
    depends_on:
      - consul-server
      - vault
      - fluentd
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'

  enrollerui:
    build:
      context: https://github.com/lamassuiot/enroller-ui.git#develop
    volumes:
      - '${ENROLLER_FRONTEND_PATH}/certs:/etc/nginx/certs/server'
    networks:
      - lamassu-net
    ports:
      - ${ENROLLER_UIPORT}:443
    depends_on:
      - fluentd
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'
  
  enrollerdb:
    image: 'postgres:latest'
    environment:
      POSTGRES_DB: '${ENROLLER_POSTGRESDB}'
      POSTGRES_USER: '${ENROLLER_POSTGRESUSER}'
      POSTGRES_PASSWORD: '${ENROLLER_POSTGRESPASSWORD}'
    volumes:
      - 'enroller_pg_data:/var/lib/postgresql/data'
      - '${ENROLLER_PATH}/db/create.sql:/docker-entrypoint-initdb.d/create.sql'
    networks:
      - lamassu-net
    depends_on:
      - fluentd
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'

  manufacturingenroll:
    build:
      context: https://github.com/lamassuiot/device-manufacturing-system.git#develop
      dockerfile: Dockerfile.manufacturingenroll
    environment:
      ENROLLER_PORT: '${MANUFACTURINGENROLL_PORT}'
      ENROLLER_UIHOST: '${MANUFACTURING_UIHOST}'
      ENROLLER_UIPORT: '${MANUFACTURING_UIPORT}'
      ENROLLER_UIPROTOCOL: '${MANUFACTURING_UIPROTOCOL}'
      ENROLLER_POSTGRESUSER: '${ENROLLER_POSTGRESUSER}'
      ENROLLER_POSTGRESDB: '${ENROLLER_POSTGRESDB}'
      ENROLLER_POSTGRESPASSWORD: '${ENROLLER_POSTGRESPASSWORD}'
      ENROLLER_POSTGRESHOSTNAME: '${ENROLLER_POSTGRESHOSTNAME}'
      ENROLLER_POSTGRESPORT: '${ENROLLER_POSTGRESPORT}'
      ENROLLER_KEYCLOAKHOSTNAME: '${KEYCLOAKHOSTNAME}'
      ENROLLER_KEYCLOAKPORT: '${KEYCLOAKPORT}'
      ENROLLER_KEYCLOAKPROTOCOL: '${KEYCLOAKPROTOCOL}'
      ENROLLER_KEYCLOAKREALM: '${KEYCLOAKREALM}'
      ENROLLER_KEYCLOAKCA: '${MANUFACTURINGENROLL_KEYCLOAKCA}'
      ENROLLER_CERTFILE: '${MANUFACTURINGENROLL_CERTFILE}'
      ENROLLER_KEYFILE: '${MANUFACTURINGENROLL_KEYFILE}'
      ENROLLER_PROXYADDRESS: '${MANUFACTURINGENROLL_PROXYADDRESS}'
      ENROLLER_PROXYCA: '${MANUFACTURINGENROLL_PROXYCA}'
      ENROLLER_CONSULPROTOCOL: '${CONSULPROTOCOL}'
      ENROLLER_CONSULHOST: '${CONSULHOST}'
      ENROLLER_CONSULPORT: '${CONSULPORT}'
      ENROLLER_CONSULCA: '${MANUFACTURINGENROLL_CONSULCA}'
      JAEGER_SERVICE_NAME: '${MANUFACTURINGENROLL_JAEGER_SERVICE_NAME}'
      JAEGER_AGENT_HOST: '${JAEGER_AGENT_HOST}'
      JAEGER_AGENT_PORT: '${JAEGER_AGENT_PORT}'
    volumes:
      - ${DEVICE_MANUFACTURING_PATH}/certs:${MANUFACTURINGENROLL_CERTSPATH}
    ports:
      - ${MANUFACTURINGENROLL_PORT}:${MANUFACTURINGENROLL_PORT}
    networks:
      - lamassu-net
    restart: on-failure
    depends_on:
      - enrollerdb
      - consul-server
      - enroller
      - fluentd
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'

  manufacturing:
    build:
      context: https://github.com/lamassuiot/device-manufacturing-system.git#develop
      dockerfile: Dockerfile.manufacturing
    environment:
      MANUFACTURING_PORT: '${MANUFACTURING_PORT}'
      MANUFACTURING_UIHOST: '${MANUFACTURING_UIHOST}'
      MANUFACTURING_UIPORT: '${MANUFACTURING_UIPORT}'
      MANUFACTURING_UIPROTOCOL: '${MANUFACTURING_UIPROTOCOL}'
      MANUFACTURING_KEYCLOAKHOSTNAME: '${KEYCLOAKHOSTNAME}'
      MANUFACTURING_KEYCLOAKPORT: '${KEYCLOAKPORT}'
      MANUFACTURING_KEYCLOAKPROTOCOL: '${KEYCLOAKPROTOCOL}'
      MANUFACTURING_KEYCLOAKREALM: '${KEYCLOAKREALM}'
      MANUFACTURING_KEYCLOAKCA: '${MANUFACTURING_KEYCLOAKCA}'
      MANUFACTURING_CERTFILE: '${MANUFACTURING_CERTFILE}'
      MANUFACTURING_KEYFILE: '${MANUFACTURING_KEYFILE}'
      MANUFACTURING_AUTHKEYFILE: '${MANUFACTURING_AUTHKEYFILE}'
      MANUFACTURING_PROXYADDRESS: '${MANUFACTURING_PROXYADDRESS}'
      MANUFACTURING_PROXYCA: '${MANUFACTURING_PROXYCA}'
      MANUFACTURING_CONSULPROTOCOL: '${CONSULPROTOCOL}'
      MANUFACTURING_CONSULHOST: '${CONSULHOST}'
      MANUFACTURING_CONSULPORT: '${CONSULPORT}'
      MANUFACTURING_CONSULCA: '${MANUFACTURING_CONSULCA}'
      JAEGER_SERVICE_NAME: '${MANUFACTURING_JAEGER_SERVICE_NAME}'
      JAEGER_AGENT_HOST: '${JAEGER_AGENT_HOST}'
      JAEGER_AGENT_PORT: '${JAEGER_AGENT_PORT}'
    volumes:
      - '${DEVICE_MANUFACTURING_PATH}/certs:${MANUFACTURING_CERTSPATH}'
    ports:
      - ${MANUFACTURING_PORT}:${MANUFACTURING_PORT}
    networks:
      - lamassu-net
    restart: on-failure
    depends_on: 
      - consul-server
      - scepextension
      - fluentd
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'
  
  manufacturingui:
    build:
      context: https://github.com/lamassuiot/device-manufacturing-system-ui.git#develop
    volumes:
      - '${DEVICE_MANUFACTURING_FRONTEND}/certs:/etc/nginx/certs/server'
    ports:
      - ${MANUFACTURING_UIPORT}:443
    networks:
      - lamassu-net
    depends_on:
      - fluentd
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'
  
  scepextension:
    build:
      context: https://github.com/lamassuiot/scep.git
      dockerfile: Dockerfile.extension
    environment:
      SCEPEXTENSION_PORT: '${SCEPEXTENSION_PORT}'
      SCEPEXTENSION_CONSULPROTOCOL: '${CONSULPROTOCOL}'
      SCEPEXTENSION_CONSULHOST: '${CONSULHOST}'
      SCEPEXTENSION_CONSULPORT: '${CONSULPORT}'
      SCEPEXTENSION_CONSULCA: '${SCEPEXTENSION_CONSULCA}'
      SCEPEXTENSION_CERTFILE: '${SCEPEXTENSION_CERTFILE}'
      SCEPEXTENSION_KEYFILE: '${SCEPEXTENSION_KEYFILE}'
      SCEPEXTENSION_SERVERPORT: '${SCEPEXTENSION_SERVERPORT}'
      SCEPEXTENSION_SCEPMAPPING: '${SCEPEXTENSION_SCEPMAPPING}'
      SCEPEXTENSION_PROXYCA: '${SCEPEXTENSION_PROXYCA}'
      SCEPEXTENSION_PROXYHOST: '${SCEPEXTENSION_PROXYHOST}'
      SCEPEXTENSION_PROXYPORT: '${SCEPEXTENSION_PROXYPORT}'
      JAEGER_SERVICE_NAME: '${SCEPEXTENSION_JAEGER_SERVICE_NAME}'
      JAEGER_AGENT_HOST: '${JAEGER_AGENT_HOST}'
      JAEGER_AGENT_PORT: '${JAEGER_AGENT_PORT}'
    volumes:
      - ${SCEP_PATH}/certs:/certs
    ports:
      - ${SCEPEXTENSION_PORT}:${SCEPEXTENSION_PORT}
    networks:
      - lamassu-net
    restart: on-failure
    depends_on: 
      - consul-server
      - fluentd
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'
  
  scepproxy:
    build:
      context: https://github.com/lamassuiot/scep.git#:proxy
    volumes:
      - ${SCEP_PATH}/proxy/log:/var/log/nginx
      - ${SCEP_PATH}/proxy/server/certs:${NGINX_SERVER_CERTS}
      - ${SCEP_PATH}/proxy/client/certs:${NGINX_CLIENT_CERTS}
    networks:
      - lamassu-net
    depends_on:
      - fluentd
      - scepextension
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'
    
  scepca4:
    build:
      context: https://github.com/lamassuiot/scep.git
    environment:
      SCEP_HTTP_LISTEN_PORT: '${SCEP_HTTP_LISTEN_PORT}'
      SCEP_VAULT_ADDRESS: '${VAULT_API_ADDR}'
      SCEP_VAULT_CA: '${SCEP_VAULT_CA4}'
      SCEP_VAULT_CA_CERT: '${SCEP_VAULT_CA_CERT}'
      SCEP_ROLE_ID: '${SCEP_CA4_ROLE_ID}'
      SCEP_SECRET_ID: '${SCEP_CA4_SECRET_ID}'
      SCEP_FILE_DEPOT: '${SCEP_FILE_DEPOT}'
      SCEP_DB_NAME: '${SCEP_POSTGRESDB}'
      SCEP_DB_USER: '${SCEP_POSTGRESUSER}'
      SCEP_DB_PASSWORD: '${SCEP_POSTGRESPASSWORD}'
      SCEP_DB_HOST: '${SCEP_POSTGRESHOSTNAME}'
      SCEP_DB_PORT: '${SCEP_POSTGRESPORT}'
      SCEP_CONSULPROTOCOL: '${CONSULPROTOCOL}'
      SCEP_CONSULHOST: '${CONSULHOST}'
      SCEP_CONSULPORT: '${CONSULPORT}'
      SCEP_CONSULCA: '${SCEP_CONSULCA}'
      SCEP_HOST: '${SCEP_CA4_HOST}'
      SCEP_LOG_JSON: '${SCEP_LOG_JSON}'
      JAEGER_SERVICE_NAME: '${SCEP_CA4_JAEGER_SERVICE_NAME}'
      JAEGER_AGENT_HOST: '${JAEGER_AGENT_HOST}'
      JAEGER_AGENT_PORT: '${JAEGER_AGENT_PORT}'
    volumes:
      - '${SCEP_PATH}/ca:${SCEP_FILE_DEPOT}'
      - '${SCEP_PATH}/certs:/certs'
    networks:
      - lamassu-net
    restart: on-failure
    depends_on: 
      - scepdb
      - consul-server
      - vault
      - fluentd
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'
  
  scepca3:
    build:
      context: https://github.com/lamassuiot/scep.git
    environment:
      SCEP_HTTP_LISTEN_PORT: '${SCEP_HTTP_LISTEN_PORT}'
      SCEP_VAULT_ADDRESS: '${VAULT_API_ADDR}'
      SCEP_VAULT_CA: '${SCEP_VAULT_CA3}'
      SCEP_VAULT_CA_CERT: '${SCEP_VAULT_CA_CERT}'
      SCEP_ROLE_ID: '${SCEP_CA3_ROLE_ID}'
      SCEP_SECRET_ID: '${SCEP_CA3_SECRET_ID}'
      SCEP_FILE_DEPOT: '${SCEP_FILE_DEPOT}'
      SCEP_DB_NAME: '${SCEP_POSTGRESDB}'
      SCEP_DB_USER: '${SCEP_POSTGRESUSER}'
      SCEP_DB_PASSWORD: '${SCEP_POSTGRESPASSWORD}'
      SCEP_DB_HOST: '${SCEP_POSTGRESHOSTNAME}'
      SCEP_DB_PORT: '${SCEP_POSTGRESPORT}'
      SCEP_CONSULPROTOCOL: '${CONSULPROTOCOL}'
      SCEP_CONSULHOST: '${CONSULHOST}'
      SCEP_CONSULPORT: '${CONSULPORT}'
      SCEP_CONSULCA: '${SCEP_CONSULCA}'
      SCEP_HOST: '${SCEP_CA3_HOST}'
      SCEP_LOG_JSON: '${SCEP_LOG_JSON}'
      JAEGER_SERVICE_NAME: '${SCEP_CA3_JAEGER_SERVICE_NAME}'
      JAEGER_AGENT_HOST: '${JAEGER_AGENT_HOST}'
      JAEGER_AGENT_PORT: '${JAEGER_AGENT_PORT}'
    volumes:
      - '${SCEP_PATH}/ca:${SCEP_FILE_DEPOT}'
      - '${SCEP_PATH}/certs:/certs'
    networks:
      - lamassu-net
    restart: on-failure
    depends_on:
      - scepdb
      - consul-server
      - vault
      - fluentd
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'
    
  scepca2:
    build:
      context: https://github.com/lamassuiot/scep.git
    environment:
      SCEP_HTTP_LISTEN_PORT: '${SCEP_HTTP_LISTEN_PORT}'
      SCEP_VAULT_ADDRESS: '${VAULT_API_ADDR}'
      SCEP_VAULT_CA: '${SCEP_VAULT_CA2}'
      SCEP_VAULT_CA_CERT: '${SCEP_VAULT_CA_CERT}'
      SCEP_ROLE_ID: '${SCEP_CA2_ROLE_ID}'
      SCEP_SECRET_ID: '${SCEP_CA2_SECRET_ID}'
      SCEP_FILE_DEPOT: '${SCEP_FILE_DEPOT}'
      SCEP_DB_NAME: '${SCEP_POSTGRESDB}'
      SCEP_DB_USER: '${SCEP_POSTGRESUSER}'
      SCEP_DB_PASSWORD: '${SCEP_POSTGRESPASSWORD}'
      SCEP_DB_HOST: '${SCEP_POSTGRESHOSTNAME}'
      SCEP_DB_PORT: '${SCEP_POSTGRESPORT}'
      SCEP_CONSULPROTOCOL: '${CONSULPROTOCOL}'
      SCEP_CONSULHOST: '${CONSULHOST}'
      SCEP_CONSULPORT: '${CONSULPORT}'
      SCEP_CONSULCA: '${SCEP_CONSULCA}'
      SCEP_HOST: '${SCEP_CA2_HOST}'
      SCEP_LOG_JSON: '${SCEP_LOG_JSON}'
      JAEGER_SERVICE_NAME: '${SCEP_CA2_JAEGER_SERVICE_NAME}'
      JAEGER_AGENT_HOST: '${JAEGER_AGENT_HOST}'
      JAEGER_AGENT_PORT: '${JAEGER_AGENT_PORT}'
    volumes:
      - '${SCEP_PATH}/ca:${SCEP_FILE_DEPOT}'
      - '${SCEP_PATH}/certs:/certs'
    networks:
      - lamassu-net
    restart: on-failure
    depends_on: 
      - scepdb
      - consul-server
      - vault
      - fluentd
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'

  scepca1:
    build:
      context: https://github.com/lamassuiot/scep.git
    environment:
      SCEP_HTTP_LISTEN_PORT: '${SCEP_HTTP_LISTEN_PORT}'
      SCEP_VAULT_ADDRESS: '${VAULT_API_ADDR}'
      SCEP_VAULT_CA: '${SCEP_VAULT_CA1}'
      SCEP_VAULT_CA_CERT: '${SCEP_VAULT_CA_CERT}'
      SCEP_ROLE_ID: '${SCEP_CA1_ROLE_ID}'
      SCEP_SECRET_ID: '${SCEP_CA1_SECRET_ID}'
      SCEP_FILE_DEPOT: '${SCEP_FILE_DEPOT}'
      SCEP_DB_NAME: '${SCEP_POSTGRESDB}'
      SCEP_DB_USER: '${SCEP_POSTGRESUSER}'
      SCEP_DB_PASSWORD: '${SCEP_POSTGRESPASSWORD}'
      SCEP_DB_HOST: '${SCEP_POSTGRESHOSTNAME}'
      SCEP_DB_PORT: '${SCEP_POSTGRESPORT}'
      SCEP_CONSULPROTOCOL: '${CONSULPROTOCOL}'
      SCEP_CONSULHOST: '${CONSULHOST}'
      SCEP_CONSULPORT: '${CONSULPORT}'
      SCEP_CONSULCA: '${SCEP_CONSULCA}'
      SCEP_HOST: '${SCEP_CA1_HOST}'
      SCEP_LOG_JSON: '${SCEP_LOG_JSON}'
      JAEGER_SERVICE_NAME: '${SCEP_CA1_JAEGER_SERVICE_NAME}'
      JAEGER_AGENT_HOST: '${JAEGER_AGENT_HOST}'
      JAEGER_AGENT_PORT: '${JAEGER_AGENT_PORT}'
    volumes:
      - '${SCEP_PATH}/ca:${SCEP_FILE_DEPOT}'
      - '${SCEP_PATH}/certs:/certs'
    networks:
      - lamassu-net
    restart: on-failure
    depends_on:
      - scepdb
      - consul-server
      - vault
      - fluentd
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'

  scepdb:
    image: 'postgres:latest'
    environment:
      POSTGRES_DB: '${SCEP_POSTGRESDB}'
      POSTGRES_USER: '${SCEP_POSTGRESUSER}'
      POSTGRES_PASSWORD: '${SCEP_POSTGRESPASSWORD}'
    volumes:
      - 'scep_pg_data:/var/lib/postgresql/data'
      - '${SCEP_PATH}/db/create.sql:/docker-entrypoint-initdb.d/create.sql'
    networks:
      - lamassu-net
    depends_on:
      - fluentd
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'

  ocsp:
    build:
      context: https://github.com/lamassuiot/GOCSP-responder.git
    environment:
      RESPONDER_VAULT_ADDRESS: '${VAULT_API_ADDR}'
      RESPONDER_VAULT_ROLE_ID: '${RESPONDER_VAULT_ROLE_ID}'
      RESPONDER_VAULT_SECRET_ID: '${RESPONDER_VAULT_SECRET_ID}'
      RESPONDER_FILE_CA: '${RESPONDER_FILE_CA}'
      RESPONDER_KEY: '${RESPONDER_KEY}'
      RESPONDER_CERT: '${RESPONDER_CERT}'
      RESPONDER_DB_NAME: '${ENROLLER_POSTGRESDB}'
      RESPONDER_DB_USER: '${ENROLLER_POSTGRESUSER}'
      RESPONDER_DB_PASSWORD: '${ENROLLER_POSTGRESPASSWORD}'
      RESPONDER_DB_HOST: '${ENROLLER_POSTGRESHOSTNAME}'
      RESPONDER_DB_PORT: '${ENROLLER_POSTGRESPORT}'
      RESPONDER_PORT: '${RESPONDER_PORT}'
      RESPONDER_CONSUL_PROTOCOL: '${CONSULPROTOCOL}'
      RESPONDER_CONSUL_HOST: '${CONSULHOST}'
      RESPONDER_CONSUL_PORT: '${CONSULPORT}'
      RESPONDER_CONSUL_CA: '${RESPONDER_CONSUL_CA}'
      JAEGER_SERVICE_NAME: '${RESPONDER_JAEGER_SERVICE_NAME}'
      JAEGER_AGENT_HOST: '${JAEGER_AGENT_HOST}'
      JAEGER_AGENT_PORT: '${JAEGER_AGENT_PORT}'
    volumes:
      - '${RESPONDER_PATH}/certs:${RESPONDER_CERTS_PATH}'
      - '${RESPONDER_PATH}/ca:${RESPONDER_CA_PATH}'
    networks:
      - lamassu-net
    restart: on-failure
    depends_on:
      - scepdb
      - consul-server
      - fluentd
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'
  
  device:
    build:
      context: https://github.com/lamassuiot/device-virtual.git#develop
    environment:
      DEVICE_PORT: '${DEVICE_PORT}'
      DEVICE_UIHOST: '${DEVICE_UIHOST}'
      DEVICE_UIPORT: '${DEVICE_UIPORT}'
      DEVICE_UIPROTOCOL: '${DEVICE_UIPROTOCOL}'
      DEVICE_CAPATH: '${DEVICE_CAPATH}'
      DEVICE_CERTFILE: '${DEVICE_CERTFILE}'
      DEVICE_KEYFILE: '${DEVICE_KEYFILE}'
      DEVICE_CONSULPROTOCOL: '${CONSULPROTOCOL}'
      DEVICE_CONSULHOST: '${CONSULHOST}'
      DEVICE_CONSULPORT: '${CONSULPORT}'
      DEVICE_CONSULCA: '${DEVICE_CONSULCA}'
      JAEGER_SERVICE_NAME: '${DEVICE_JAEGER_SERVICE_NAME}'
      JAEGER_AGENT_HOST: '${JAEGER_AGENT_HOST}'
      JAEGER_AGENT_PORT: '${JAEGER_AGENT_PORT}'
    volumes:
      - '${DEVICE_VIRTUAL_PATH}/ca/cacert.pem:${DEVICE_CAPATH}'
      - '${DEVICE_VIRTUAL_PATH}/certs:${DEVICE_CERTSPATH}'
    ports:
      - ${DEVICE_PORT}:${DEVICE_PORT}
    networks:
      - lamassu-net
    restart: on-failure
    depends_on:
      - consul-server
      - fluentd
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'
    
  deviceui:
    build:
      context: https://github.com/lamassuiot/device-virtual-ui.git#develop
    volumes:
      - '${DEVICE_VIRTUAL_FRONTEND}/certs:/etc/nginx/certs/server'
    ports:
      - ${DEVICE_UIPORT}:443
    networks:
      - lamassu-net
    depends_on:
      - fluentd
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'
  
  mosquitto:
    image: eclipse-mosquitto:latest
    volumes:
      - '${MQTT_GATEWAY_PATH}/certs:/mosquitto/certs'
      - '${MQTT_GATEWAY_PATH}/capath:/mosquitto/ca'
      - '${MQTT_GATEWAY_PATH}/config:/mosquitto/config'
      - 'mosquitto_data:/mosquitto/data'
    ports:
      - ${MOSQUITTO_PORT}:${MOSQUITTO_PORT}
      - ${MOSQUITTOUI_PORT}:${MOSQUITTOUI_PORT}
    networks:
      - lamassu-net
    depends_on:
      - fluentd
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'
    
  prometheus:
    image: prom/prometheus:latest
    ports:
      - ${PROMETHEUS_PORT}:${PROMETHEUS_PORT}
    volumes:
      - '${PROMETHEUS_PATH}/config/prometheus.yml:/etc/prometheus/prometheus.yml'
      - '${PROMETHEUS_PATH}/certs/consul-server.crt:/etc/prometheus/certs/consul-server.crt'
    networks:
      lamassu-net:
    depends_on:
      - fluentd
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'
    
  jaeger:
    image: jaegertracing/all-in-one:latest
    environment:
      SPAN_STORAGE_TYPE: 'elasticsearch'
      ES_USERNAME: '${ELASTIC_USERNAME}'
      ES_PASSWORD: '${ELASTIC_PASSWORD}'
      ES_SERVER_URLS: 'https://elastic:9200'
      ES_TLS_ENABLED: 'true'
      ES_TLS_CA: '${JAEGER_CERTS_DIR}/elastic.crt'
      ES_TLS_CERT: '${JAEGER_CERTS_DIR}/jaeger.crt'
      ES_TLS_KEY: '${JAEGER_CERTS_DIR}/jaeger.key'
      ES_TLS_SERVER_NAME: '${ES_TLS_SERVER_NAME}'
    volumes:
      - '${JAEGER_PATH}/certs/jaeger:${JAEGER_CERTS_DIR}'
    ports:
      - 5775:5775/udp
      - 6831:6831/udp
      - 6832:6832/udp
      - 5778:5778
      - 16686:16686
      - 14268:14268
      - 14250:14250
      - 9411:9411
    networks:
      lamassu-net:
    depends_on: 
      - elastic
      - fluentd
    restart: on-failure
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'

  elastic:
    image: docker.elastic.co/elasticsearch/elasticsearch:7.10.2
    environment:
      node.name: 'elastic'
      discovery.type: 'single-node'
      ELASTIC_CERTS_DIR: '${ELASTIC_CERTS_DIR}'
      ELASTIC_PASSWORD: '${ELASTIC_PASSWORD}'
    volumes:
      - 'elastic_data:/usr/share/elasticsearch/data'
      - '${ELASTIC_PATH}/configs/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml:ro'
      - '${ELASTIC_PATH}/certs/elastic/elastic.crt:${ELASTIC_CERTS_DIR}/elastic.crt'
      - '${ELASTIC_PATH}/certs/elastic/elastic.key:${ELASTIC_CERTS_DIR}/elastic.key'
    ports:
      - 9200:9200
      - 9300:9300
    networks:
      lamassu-net:
    depends_on:
      - fluentd
    logging:
      driver: fluentd
      options:
        fluentd-address: localhost:${FLUENTD_PORT}
        fluentd-async-connect: 'true'
        tag: '{{.Name}}'
    
  fluentd:
    image: fluent/fluentd:latest
    ports:
      - ${FLUENTD_PORT}:${FLUENTD_PORT}
      - ${FLUENTD_PORT}:${FLUENTD_PORT}/udp
    volumes:
      - '${FLUENTD_PATH}/data:/fluentd/log'
    networks:
      - lamassu-net